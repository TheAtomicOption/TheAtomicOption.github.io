<link href="SyntaxCore.css" rel="stylesheet" />
<link href="syntaxtheme.css" rel="stylesheet" />
<article id="post-113" class="post-113 post type-post status-publish format-standard hentry category-uncategorized tag-blazor tag-c tag-dependency-injection">
	<header class="entry-header">
		<h1 class="entry-title">Registering Services Automatically with&nbsp;Blazor</h1>		
		<div class="entry-meta">
			<span class="posted-on"><time class="entry-date published" datetime="2021-03-03T19:24:40-08:00">March 3, 2021</time></span>
			</div>
	</header><!-- .entry-header -->

	<div class="entry-content">
		
<p>While working on a new Blazor project recently, I noticed that the number of services was starting to grow dramatically. Following the basic tutorials and adding a line in the Startup Configure method like <code>services.AddSingleton&lt;Type&gt;();</code> for each service was quickly becoming a mess. <br><br>Looking around the internet for a solution yielded a number of examples of architectures more complex than the basic tutorial, with most of them centered around some variation of Clean Architecture (Onion Architecture) and the Repository pattern, built on top of Entity Framework. If your project is using both of those let me save you some time by linking to <a rel="noreferrer noopener" href="https://brianbu.com/2019/09/25/the-repository-pattern-isnt-an-anti-pattern-youre-just-doing-it-wrong/" target="_blank">an article on Avoiding Common Repository Pattern Mistakes,</a> a Youtube <a rel="noreferrer noopener" href="https://www.youtube.com/watch?v=vRZ8ucGac8M" target="_blank">video on the Microsoft example app eShopeOnWeb architecture,</a> a YouTube <a rel="noreferrer noopener" href="https://www.youtube.com/watch?v=joNTQy-KXiU" target="_blank">video on Clean Architecture</a>. Those sources and their linked examples should hopefully get you where you need to go.<br><br>However for reasons outside the scope of this write-up, my project is <em>not </em>using Entity Framework or the Repository Pattern, so a generic repository behind a single service doesn’t solve the problem of service list bloat. I needed a way to identify all the services I have or will create in the future, and add them to the <code>ServicesCollection</code> without having to add each one individually. </p>



<p>I spent entirely too long searching for a well documented example of how to do this, and didn’t find one, hence this post. The app is split into several projects but the important ones for this context are the main web project containing <code>Startup</code> and all the Blazor components, and the <code>BlazorApp.Business</code> project where all the services reside. If we were using the Clean Architecture template, these would roughly correspond to Web and Core respectively. Let’s look at some of the current-working draft of my code to see how I ended up solving the problem.<br><br>The app has several projects in the solution. First, this code is in the main Blazor web project:</p>


<div><div id="highlighter_422997" class="syntaxhighlighter  csharp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="csharp comments">//the BlazorApp.Businees class library that holds all our services</code></div><div class="line number2 index1 alt1"><code class="csharp comments">// and importantly the ILifetimeService&lt;T&gt; interface</code></div><div class="line number3 index2 alt2"><code class="csharp plain">Using BlazorApp.Business;</code></div><div class="line number4 index3 alt1"><code class="csharp plain">...</code></div><div class="line number5 index4 alt2"><code class="csharp keyword">public</code> <code class="csharp keyword">static</code> <code class="csharp keyword">class</code> <code class="csharp plain">BusinessServiceLoader </code></div><div class="line number6 index5 alt1"><code class="csharp plain">{</code></div><div class="line number7 index6 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp color1">/// &lt;summary&gt;</code></div><div class="line number8 index7 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp color1">/// Adds Reliance services implementing I[Lifetime]Service&lt;Type&gt; flag interfaces</code></div><div class="line number9 index8 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp color1">/// &lt;/summary&gt;</code></div><div class="line number10 index9 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">public</code> <code class="csharp keyword">static</code> <code class="csharp plain">IServiceCollection GetBusinessServices(</code><code class="csharp keyword">this</code> <code class="csharp plain">IServiceCollection services)</code></div><div class="line number11 index10 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number12 index11 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">foreach</code> <code class="csharp plain">(Type service </code><code class="csharp keyword">in</code> <code class="csharp plain">Assembly.GetAssembly(</code><code class="csharp keyword">typeof</code><code class="csharp plain">(ITransientService&lt;&gt;))!.GetTypesWithInterface(</code><code class="csharp keyword">typeof</code><code class="csharp plain">(ITransientService&lt;Type&gt;)))</code></div><div class="line number13 index12 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number14 index13 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">services.AddTransient(service);</code></div><div class="line number15 index14 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number16 index15 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">foreach</code> <code class="csharp plain">(Type service </code><code class="csharp keyword">in</code> <code class="csharp plain">Assembly.GetAssembly(</code><code class="csharp keyword">typeof</code><code class="csharp plain">(IScopedService&lt;&gt;))!.GetTypesWithInterface(</code><code class="csharp keyword">typeof</code><code class="csharp plain">(IScopedService&lt;Type&gt;)))</code></div><div class="line number17 index16 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number18 index17 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">services.AddScoped(service);</code></div><div class="line number19 index18 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number20 index19 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">foreach</code> <code class="csharp plain">(Type service </code><code class="csharp keyword">in</code> <code class="csharp plain">Assembly.GetAssembly(</code><code class="csharp keyword">typeof</code><code class="csharp plain">(ISingletonService&lt;&gt;))!.GetTypesWithInterface(</code><code class="csharp keyword">typeof</code><code class="csharp plain">(ISingletonService&lt;Type&gt;)))</code></div><div class="line number21 index20 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number22 index21 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">services.AddSingleton(service);</code></div><div class="line number23 index22 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number24 index23 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">return</code> <code class="csharp plain">services;</code></div><div class="line number25 index24 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number26 index25 alt1"><code class="csharp plain">}</code></div><div class="line number27 index26 alt2">&nbsp;</div><div class="line number28 index27 alt1"><code class="csharp comments">// utility extension methods adapted from StackOverflow: </code></div><div class="line number29 index28 alt2"><code class="csharp comments">// <a href="https://stackoverflow.com/a/29379834/3626160">https://stackoverflow.com/a/29379834/3626160</a></code></div><div class="line number30 index29 alt1"><code class="csharp keyword">internal</code> <code class="csharp keyword">static</code> <code class="csharp keyword">class</code> <code class="csharp plain">TypeLoaderExtensions</code></div><div class="line number31 index30 alt2"><code class="csharp plain">{</code></div><div class="line number32 index31 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">internal</code> <code class="csharp keyword">static</code> <code class="csharp plain">IEnumerable&lt;Type&gt; GetLoadableTypes(</code><code class="csharp keyword">this</code> <code class="csharp plain">Assembly assembly)</code></div><div class="line number33 index32 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number34 index33 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">if</code> <code class="csharp plain">(assembly == </code><code class="csharp keyword">null</code><code class="csharp plain">) </code><code class="csharp keyword">throw</code> <code class="csharp keyword">new</code> <code class="csharp plain">ArgumentNullException(nameof(assembly));</code></div><div class="line number35 index34 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">try</code></div><div class="line number36 index35 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number37 index36 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">return</code> <code class="csharp plain">assembly.GetTypes();</code></div><div class="line number38 index37 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number39 index38 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">catch</code> <code class="csharp plain">(ReflectionTypeLoadException ex)</code></div><div class="line number40 index39 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number41 index40 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">return</code> <code class="csharp plain">ex.Types.Where(t =&gt; t != </code><code class="csharp keyword">null</code><code class="csharp plain">)!;</code></div><div class="line number42 index41 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number43 index42 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number44 index43 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">internal</code> <code class="csharp keyword">static</code> <code class="csharp plain">IEnumerable&lt;Type&gt; GetTypesWithInterface(</code><code class="csharp keyword">this</code> <code class="csharp plain">Assembly asm, Type type)</code></div><div class="line number45 index44 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">{</code></div><div class="line number46 index45 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp keyword">return</code> <code class="csharp plain">asm.GetLoadableTypes()</code></div><div class="line number47 index46 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">.Where(type.IsAssignableFrom)</code></div><div class="line number48 index47 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">.Where(t =&gt; !(t.Equals(type))).ToList();</code></div><div class="line number49 index48 alt2"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">}</code></div><div class="line number50 index49 alt1"><code class="csharp plain">}</code></div></div></td></tr></tbody></table></div></div>


<p>The interfaces used are in the <code>BlazorApp.Business</code> class library referenced by the web project, but they could just as easily be in a third project so long as both projects reference it:</p>


<div><div id="highlighter_346341" class="syntaxhighlighter  csharp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="csharp color1">/// &lt;summary&gt;</code></div><div class="line number2 index1 alt1"><code class="csharp color1">/// Empty interface that marks classes as a service to be registered in the web app as Transient</code></div><div class="line number3 index2 alt2"><code class="csharp color1">/// &lt;/summary&gt;</code></div><div class="line number4 index3 alt1"><code class="csharp keyword">public</code> <code class="csharp keyword">interface</code> <code class="csharp plain">ITransientService&lt;T&gt;</code></div><div class="line number5 index4 alt2"><code class="csharp plain">{ }</code></div><div class="line number6 index5 alt1"><code class="csharp color1">/// &lt;summary&gt;</code></div><div class="line number7 index6 alt2"><code class="csharp color1">/// Empty interface that marks classes as a service to be registered in the web app as Scoped</code></div><div class="line number8 index7 alt1"><code class="csharp color1">/// &lt;/summary&gt;</code></div><div class="line number9 index8 alt2"><code class="csharp keyword">public</code> <code class="csharp keyword">interface</code> <code class="csharp plain">IScopedService&lt;T&gt; </code></div><div class="line number10 index9 alt1"><code class="csharp plain">{ }</code></div><div class="line number11 index10 alt2"><code class="csharp color1">/// &lt;summary&gt;</code></div><div class="line number12 index11 alt1"><code class="csharp color1">/// Empty interface that marks classes as a service to be registered in the web app as Singletons</code></div><div class="line number13 index12 alt2"><code class="csharp color1">/// &lt;/summary&gt;</code></div><div class="line number14 index13 alt1"><code class="csharp keyword">public</code> <code class="csharp keyword">interface</code> <code class="csharp plain">ISingletonService&lt;T&gt;</code></div><div class="line number15 index14 alt2"><code class="csharp plain">{ }</code></div></div></td></tr></tbody></table></div></div>


<p>Services in <code>BlazorApp.Business</code> are easy to change in order to mark them for loading:</p>


<div><div id="highlighter_225065" class="syntaxhighlighter  csharp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="csharp keyword">public</code> <code class="csharp keyword">class</code> <code class="csharp plain">ExampleScopedService : IScopedService&lt;Type&gt;</code></div><div class="line number2 index1 alt1"><code class="csharp plain">{</code></div><div class="line number3 index2 alt2"><code class="csharp comments">//methods </code></div><div class="line number4 index3 alt1"><code class="csharp plain">}</code></div></div></td></tr></tbody></table></div></div>


<p>and finally to pull it all together, back in the main web project, we can load all services in our <code>Startup.cs</code> with </p>


<div><div id="highlighter_410130" class="syntaxhighlighter  csharp"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="csharp keyword">public</code> <code class="csharp keyword">void</code> <code class="csharp plain">ConfigureServices(IServiceCollection services) {</code></div><div class="line number2 index1 alt1"><code class="csharp plain">...</code></div><div class="line number3 index2 alt2"><code class="csharp plain">services.GetBusinessServices();</code></div><div class="line number4 index3 alt1"><code class="csharp plain">...</code></div><div class="line number5 index4 alt2"><code class="csharp plain">}</code></div></div></td></tr></tbody></table></div></div>


<p>The concept is pretty straight forward. First we need a reliable way to identify all the classes that define services which we want registered. This is done by having each service class implement a specific empty interface. No other classes implement this interface, so there’s no chance of getting classes we don’t want like there would be with some sort of name matching. We’re also restricting ourselves to classes in the same assembly as the one that defines the interfaces to further ensure no collisions with some other library we might use. <br><br>Next, because the interface is empty, we don’t have to make any implementation changes to the body of our service classes. We could even load third party classes as services by wrapping them in an empty class just to add this interface.<br><br>Services can be registered with one of three Lifetimes, so we’ll want three different interfaces.  In a more complex architecture we’d also need to have interfaces to match the signatures for <code>services.AddSingleton(TService, TImplementation)</code>, but I didn’t bother yet as that’s not currently something we need.  <br><br>Once the services are tagged with these interfaces, I created an extension method for the <code>IServicesCollection</code> interface that uses Reflection (via an extension method for the <code>Assembly</code> type) to find all of the services in the relevant assembly and add them to the instance of the services collection.<br><br>Is this the best way to solve this problem? I’m not sure. There are probably lots of other ways this could be done. Class Attribute tags come to mind. None of the code gurus I’ve run into are doing this–mostly because they’re all using EF and Repositories and don’t have many services, and maybe that’s a big clue that I should just roll over and adopt those things… But this method is working and seems to be pretty hassle free. If I’m making a huge architectural mistake, I don’t know about it <em>today</em>.<br><br>Hope this helps you out!</p>
</article>
